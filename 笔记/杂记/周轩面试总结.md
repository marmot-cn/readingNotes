# 周轩面试总结

---

## 面试前置需求

* 时间: 20180405
* 服务器IP：13.125.52.61
* SSH用户：ec2-user
* Key：ops-interview-ap-ne-2.pem

这是一个LAMP的Wordpress环境，现在环境存在如下的问题，希望你能帮助排除问题：

1. 网站无法正常工作

2. 网站的性能有问题

3. 文章的详细页面出错


在整个排错的过程中，你可以对服务器做任何你认为有必要的操作，也可以使用搜索引擎查自己需要的资料，有什么疑问或者需求请随时向面试官提出。

## 面试过程

### 登录服务器遇见的问题

面试第一步给了我一个`pem`文件, 我当时就晕了不会用这个文件. 后来发现使用`ssh -i 文件 xxx@xxxx`即可, 但是第一次使用提示:

```
Permissions 0644 for 'tom.pem' are too open.
It is required that your private key files are N
```

提示权限太大, 这里需要修改为`0600`权限即可.

具体可以看整理笔记[ssh pem文件登录](https://github.com/marmot-cn/readingNotes/blob/master/%E7%AC%94%E8%AE%B0/linux%E7%9F%A5%E8%AF%86%E7%82%B9/ssh%E7%99%BB%E5%BD%95pem%E6%96%87%E4%BB%B6%E4%BD%BF%E7%94%A8.md)

**题外话**我后来整理发现`.pem`文件和私钥文件内容一致的, 一直搞不明白为什么一定要给我`.pem`文件. @周轩得知默认`aws`给的就是`pem`文件. 没有什么具体原因.

### 网站打不开

#### 解决权限问题 

登录服务器, 发现网站打不开. 查看`httpd`的`error`日志(这里如果没有开启错误日志, 需要修改配置文件开启错误日志), 发现时文件夹权限问题, 这个问题比较简单, 只要修改对应文件夹属主和属组为`apache`即可, 这里需要使用`sudo`. 

#### 解决数据库启动问题

这时候网站打开有响应了, 但是报告数据库错误, 提示数据库连接不上. 查看`mysql`的错误日志`/var/log/mysqld.log`. 发现提示文件不能创建.

这里我考虑到两个点:

1. `inode`写满了.
2. 磁盘满了.

通过使用`df -h`查看发现根目录`/`磁盘占用`Use%`已经`100%`了, 检查临时文件(因为一般我遇见问题很多都是临时文件目录写满了), 发现有一个`6G`的`iso`文件. 我考虑:

1. 是`iso`镜像文件.
2. 在临时目录里.

直接删除`iso`文件. 然后启动`mysql`发现可以正常使用.

**如果是`inode`写满了**

通过`IUse%`检查, 删除多余的文件即可.

```
[root@iZ94ebqp9jtZ ~]# df -i
Filesystem      Inodes IUsed   IFree IUse% Mounted on
/dev/xvda1     2621440 41237 2580203    2% /
devtmpfs        124529   332  124197    1% /dev
tmpfs           126871     1  126870    1% /dev/shm
tmpfs           126871   402  126469    1% /run
tmpfs           126871    16  126855    1% /sys/fs/cgroup
tmpfs           126871     1  126870    1% /run/user/0
tmpfs           126871     1  126870    1% /run/user/1001
```

##### 解决数据库连接问题

数据库可以正常打开了但是发现还是不能连接数据库. 这个使用使用`netstat -nlp`发现没有`PID/Programe name`. 经过@周轩提示应该使用`sudo`权限执行命令, 发现`PID/Programe name`可以正常输出.

发现没有`mysql`应谁任何端口. 最初没有考虑`3306`端口, 以为肯定修改了端口号. 后来还是经过@周轩引导提示. `Linux`命令访问可以使用本地套接字或者`TCP/IP`端口号. 查看`mysql`配置文件, 发现里面使用的是本地套接字格式, 且还有`skip-networking`配置项.

当初不清楚`skip-networking`这个配置项作用, 但是字面意思理解是跳过网络链接模式.

我删除了`socket=/tmp/mysql.sock`和`skip-networking`, **但是后来查看资料得知, 删除`skip-networking`即可**

### 网站的性能有问题

#### 链接性能问题

这个问题排查起来耗费太多时间, 网站总是访问的时候部分`css`文件加载不上, 但是单独打开这个`css`文件确可以加载上. @周轩提示我`ping`下服务器. 我`ping`服务器后发现禁`ping`, 我按照习惯去看了`/etc/sysctl.conf`文件没有发现禁止`icmp`协议, **但是忽略了iptables**, 我一直禁`ping`都是通过`/etc/sysctl.conf`文件去处理, 所以一直花费很长时间都没有想到`iptables`, **主要我一直有一个错误的代入感就是,iptables是用于限制访问,即要么可以,要么不可以**, 忘了其可以限制频率, 后来查看`iptables`果然有一个`connlimit`规则限制, 删除规则既能正常访问.

后话, 服务器的禁`ping`都是通过在亚马逊做的配置, 没有在服务器防火墙配置.

**这里也是没想到网站性能是通过防火墙专门配置引起的, 一直以为是程序问题**

#### 数据库性能问题

解决了加载链接, 但是网站还是出现加载过慢的情况. 其实这里有两个考虑解决方案:

1. php慢查询日志
2. mysql慢查询日志

开启`mysql`慢查询日志, 即发现有一条`sql`语句执行耗时太长(这条语句就是执行一些全局信息检索, 和业务逻辑无关). 现在需要考虑怎么找见执行该条`sql`的文件. 执行:

```
grep -n xxx ./*
```

找见文件后, 删除该条执行`sql`即可(因为这条`sql`是和业务逻辑无关)

[grep 命令详解](https://github.com/chloroplast1983/readingNotes/blob/master/linux%E5%91%BD%E4%BB%A4/grep.md)

### 文章的详细页面出错

这个点没时间做了, 但是大概知道是伪静态问题.

## 总结

* 排查问题首先需要**查看日志**, 要把一个大问题进行细粒度切分.
* 需要查看配置文件, 检查配置文件是否有不合适的地方.
* 对于性能排查, 要善于使用**慢查询日志**.
* 对于网络要切记查看下**防火墙**.