# 第18讲 | DNS协议：网络世界的地址簿 

## 笔记

### DNS 服务器

网站名称 映射 `ip`地址, **地址簿**就是**DNS服务器**.

**DNS服务器, 一定要设置成高可用, 高并发和分布式的**

### DNS 树状的层次结构

![](./img/18_01.jpg)

* 根`DNS`服务器: 返回顶级域`DNS`服务器的`IP`地址.
* 顶级域`DNS`服务器: 返回权威`DNS`服务器的`IP`地址
* 权威`DNS`服务器, 返回响应主机的`IP`地址

### DNS 解析流程

为了提高`DNS`的解析性能, 都会就近部署`DNS`缓存服务器.

#### 1

客户端发出一个`DNS`请求, 如`www.163.com`的`IP`是啥, 并发给本地域名服务器(本地DNS). 如果是通过`DHCP`, 那么本地`DNS`由你的网络服务商(ISP), 如电信, 移动等自动分配, 通常就在网络服务商的某个机房.

#### 2

本地`DNS`收到来自客户端的请求(这台服务器上缓存了一张域名与之对应的`IP`地址的大表格).

* 如果找到, 就返回.
* 如果没有, 本地`DNS`回去问根域名服务器. 全球共有13套, 不直接用于解析, 可以指明一条道路.

#### 3

根`DNS`收到来自本地`DNS`的请求, 发现后缀是`.com`, 会说`www.163.com`这个域名是有`.com`区域管理, 我给你它的顶级域名服务器的地址, 你去问问它吧.

#### 4

本地`DNS`专项问顶级域名服务器(就是`.com,.net,.org`这些一级域名, 它负责管理二级域名, 比如`163.com`, 所以它能提供一条更清晰的方向)

#### 5

顶级域名服务器说, 我给你负责`www.163.com`区域的去权威`DNS`服务器地址, 你去问它应该能问到.

#### 6

本地`DNS`专项权威`DNS`服务器(`163.com`的权威`DNS`服务器, 它是域名解析结果的原出处), 为什么叫权威, 因为我的域名我做主

#### 7

权威`DNS`服务器查询后将对应的`IP`地址`X.X.X.X`告诉本地`DNS`.

#### 8

本地`DNS`再将`IP`地址返回给客户端, 客户端和目标建立连接.

#### DNS 解析过程

![](./img/18_02.jpg)

### 负载均衡

站在客户端角度, 这是一次**`DNS` 递归查询过程**, 因为本地`DNS`全权处理, 客户端只要坐等结果.

`DNS`还可以处理**负载均衡**.

#### 内部负载均衡

* 数据地址解析使用域名, 更换ip地址方便
* 基于域名负载均衡, 解析返回第一个IP或者返回第二个IP

#### 全局负载均衡

北京访问北京的地址, 上海访问上海的地址.

### 示例: DNS 访问数据中心对象存储上的静态资源

![](./img/18_03.jpg)

全局负载均衡器(`GSLB`, Global Server Load Balance). **跨地域跨运营商的大型应用**

在`yourcompany.com`的`DNS`服务器中, 一般是通过配置`CNAME`的方式, 给`object.yourcompany.com`起一个别名, 例如`object.vip.yourcompany.com`, 然后告诉本地`DNS`服务器, 让它请求`GSLB`解析这个域名.

第一层`GSLB`, 通过查看它的本地`DNS`服务器所在的运营商, 如果知道用户所在的运营商. 假如是移动, 通过`CNAME`的方式, 通过另一个别名`object,yd.yourcompany.com`, 告诉本地`DNS`服务器去请求第二层`GSLB`.

第二层`GSLB`, 通过查看请求它的本地`DNS`服务器所在的地址, 将距离用户位置比较近的`Region`里面, 六个内部负载均衡(SLB)的地址, 返回给本地`DNS`服务器

本地`DNS`服务器将结果返回给本地`DNS`解析器

本地`DNS`解析器将结果缓存后, 返回给本地

客户端开始访问属于相同运营商的距离较近的`Region`中的对象存储, 客户端得到了六个`IP`地址, 也可以通过负载均衡的方式轮询访问.

## 扩展