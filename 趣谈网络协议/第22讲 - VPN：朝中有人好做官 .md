# 第22讲 | VPN：朝中有人好做官 

## 笔记

### VPN

`Virtual Private Network`, 虚拟专用网. 利用开放的公众网络, 建立专用数据传输通道.

### VPN 如何工作的

`VPN`通过隧道技术在公众网络上仿真一条点到点的专线, 是通过利用一种协议来传输到另外一种协议的技术.

* 乘客协议
* 隧道协议
* 承载协议

#### 示例: IPsec 协议

![](./img/22_01.jpg)

汽车轮渡从A到B

* 乘客协议: 如开车协议, 靠右行驶, 红灯停, 绿灯行.
* 承载协议: 海上坐船航行, 看灯塔, 按航道航行.
* 隧道协议: 遵循开车协议, 将车开上轮渡, 所有通过轮渡的车都关在船舱里面, 按照既定的规则排列好.

在大海上, 车是关在船舱里面, **就像在隧道里面一样**, 内部的乘客协议么有用处. 主要船遵从外层的承载协议到达目的地即可.

到达目的地, 外部承载协议的任务就结束了, **打开船舱, 让车出来, 就相当于取下承载协议和隧道协议的头**, 接下来在目的地车该怎么开还是怎么开, 内部的**乘客协议起作用**.

### IPSec VPN

是**基于IP协议的安全隧道协议**.

* 私密性: 通过加密把数据从明文编程无法读懂的密文, 从而确保数据的私密性.
	* VPN 一旦建立, 需要传输大量数据, 要采取**对称加密**, 但是密钥传输需要用到**因特网密钥交换(IKE, Interent Key Exchange)协议.
* 完整性: 数据没有被非法篡改, 通过对数据进行`hash`运算, 产生类似于指纹的数据摘要, 以保证数据的完整性.
* 真实性: 数据确实由特定的对端发出, 通过身份认证可以保证数据的真实性.
	* 预共享密钥: 双方事先商量好一个暗号
	* 数字签名: 私钥进行签名, 对方如果能用我的数字证书里面的公钥解开, 就说明正确.

**以上三个特性组成了IPsec VPN的协议簇**

![](./img/22_02.jpg)

有两种协议, 区别在于封装网络包的格式不一样.

* `AH`(Authentication Header), 只能进行数据摘要, 不能实现数据加密.
* `ESP`(Encapsulating Security Payload), 能够进行数据加密和数据摘要.

两类算法

* 加密算法
* 摘要算法

两大组件:

* 用于`VPN`的双方进行对称密钥的交换`IKE`组件.
* `VPN`的双方要对链接进行维护的`SA`(Security Association)组件.

### IPsec VPN 的建立过程

#### 第一阶段

建立`IKE`自己的`SA`.

`SA`维护一个通过身份认证和安全保护的通道, 为第二个阶段提供服务. 通过`DH(Diffie-Hellman)`算法计算出一个对称密钥`K`.

* 客户端和服务端约定两个公开的质数`p`和`q`
* 客户端随机产生一个数`a`作为自己的私钥
* 服务端随机产生一个`b`作为自己的私钥
* 客户端可以根据`p`,`q`和`a`计算出公钥`A`
* 服务端可以根据`p`,`q`和`b`计算出公钥`B`
* 双发交换公钥`A`和`B`

客户端和服务端可以根据已有的信息, 各自独立算出相同的结果`K`, 就是**对称密钥**.

这个过程, **对称密钥从来没有在通道上传输过, 只传输了生成密钥的材料, 通过这些材料, 截获的人是无法算出的**.

![](./img/22_03.jpg)

#### 第二阶段

**有了这个对称密钥`K`**, 建立`IPsec SA`.

在这个`SA`里面, 双方会生成一个随机的对称密钥`M`, 由`K`加密传给对方, 然后使用`M`进行双方接下来通信的数据.

对称密钥`M`是有过期时间的, 会过一段时间, 重新生成一次, 防止被破解.

`IPsec SA`有以下内容:

* `SPI(Security Parameter Index)`, 用于标识不同的连接.
* 双方商量好的加密算法, 哈希算法和封装模式.
* 生存周期, 超过这个周期, 就需要重新生成一个`IPsec SA`, 重新生成对称密钥.

![](./img/22_04.jpg)

打包封装传输:

![](./img/22_05.jpg)

* 左面是原始的`IP`包
* 在`IP`头里面会指定上一层的协议为`TCP`
* `ESP`要对`IP`包进行封装, 因为`IP`头里面的上一层协议为`ESP`.
* `ESP`的正文里面, `ESP`的头部有双方商讨好的`SPI`, 以及这次传输的序列号.
* 加密内容, 可以通过对称密钥进行解密.
* 解密后在正文的最后, 指明了里面的协议是什么.
* 如果是`IP`
	* 解析`IP`头 
	* 解析`TCP`头
	* 这个是从隧道出来后解封的过程

有了`IPsec VPN`后, 客户端发送的明文的`IP`包, 都会被加上`ESP`头和`IP`头, 在公网传输, 由于加密, 可以保证安全 到了对端后, 去掉`ESP`的头, 进行解密.

![](./img/22_06.jpg)

这种**点对点基于`IP`的`VPN`**速度较慢, 因为底层`IP`协议的特性决定的. `IP`不是面向连接的, 是尽力而为的协议, 每个`IP`包自由选择路径, 到每一个路由器都自己去找下一跳, 丢了就丢了, 是靠上一层`TCP`的重发来保证可靠性.

![](./img/22_07.jpg)

因为`IP`网络从设计的时候, 就认为是不可靠的, 所以即使同一个连接, 也可能选择不同的道路. 代价就是, **不断的路由查找, 效率比较差**.

### APM

`APM`协议与`IP`协议的不同在于, 是**面向连接**的.

* `TCP`也是面向连接的, 但是和`IP`不是一个层次.
* `AMP`和`IP`是一个层次的.

`TCP`所谓的面向连接, 是**不停地重试来保证成功**, 其实下层`IP`还是不面向连接的, 丢了就丢了.

`ATM`是传输之前先建立一个连接, 形成一个**虚拟的通路**, 一旦连接建立了, 所有的包都按照相同的路径走, 不会分头行事.

![](./img/22_08.jpg)

* 优点: 不需要每次查路由表, 虚拟路径已经建立, 打上了标签, 后续的包跟着走就是了, 不用像`IP`包一样, 每个包都思考下一步怎么走, 都按相同的路径走.
* 缺点: 一旦虚拟路径上的某个路由器坏了, 则这个连接就断了, 什么也发不过去了.

**将具有全局意义的路由表改为只有本地意义的标签表, 大大提供一台路由器的转发功力**.

### 多协议标签转换

`MPLS, Multi-Protocol Label Switching`

在原始的`IP`头之外, 多了`MPLS`的头, 里面可以打标签.

![](./img/22_09.jpg)

二层头里面, 有类型字段.

* `0x0800`表示`IP`
* `0x8847`表示`MPLS Label`

`MPLS`头

* 标签值占`20`位
* 3位实验位
* 1位栈底标志位, 表示当前标签是否位于栈底了
* `TTL`存活时间段, 如果标签数据包的出发`TTL`值为`0`, 则该数据包在网络中的生命期被认为已经过期了

可以根据这个标签转发的路由器称为**标签交换路由器(LSR, Label Switching Router)**.

这种路由器有两个表格:

* FIB, 路与表
* LFIB, 标签转发表

既可以进行普通的路由转发, 也可以基于标签的转发.

![](./img/22_10.jpg)

有了标签转发表, 就不用每次都进行普通路由的查找了.

我们区分`MPLS`区域和非`MPLS`区域.

* 在`MPLS`区域中间, 使用标签进行转发.
* `非MPLS`区域, 使用普通路由表转发.

在**边缘节点上**需要有能力将对于普通路由的转发, 变成对于标签的转发.

如图, 当进入`MLS`区域, 在`IP`头外面加一个标签1.

这样一个**通过标签转换而建立的路径称为`LSP`**, 标签交换路径. 在一条`LSP`上, 沿数据包传送的方向, 相邻的`LSR`分别叫**上游LSR(upstream LSR)**和**下游LSR(downstream LSR)**

#### LDP

生成标签, `LDP (Label Distribution Protocol)`, 动态标签生成协议.

`LDP`与`IP`的路由协议类似, 通过`LSR`的交互, **互相告知去哪里应该打哪个标签, 称为标签转发**, 往往是**从下游开始**的.

![](./img/22_11.jpg)

* 边缘节点发现自己的路由表中出现了新的目的地址, 要和被人说, 我能到达一条新的路径了
* 如果此边缘节点存在上游`LSR`, 且有可供分配的标签, 则该节点为新的路径分配标签, 并向上游发出标签映射消息, 包含分配的标签等信息
* 收到标签映射消息的`LSR`记录响应的标签映射信息, 在其标签转发表中增加相应的条目.
* 此`LSR`为它的上游`LSR`分配标签, 继续向上游`LSR`发送标签映射消息.
* 当**入口**LSR收到标签映射消息时, 在标签转发表中增加相应的条目.
* 完成了`LSP`的建立

**如果VPN通道里面包的转发, 都是通过标签的方式进行, 效率会高很多**

#### MPLS VPN

![](./img/22_12.jpg)

路由器:

* PE(Provider Edge): 运营商网络与客户网络相连的边缘网络设备.
* CE(Customer Edge): 客户网络与`PE`相连的边缘设备.
* P(Provider): 运营商网络中除`PE`之外的其他运营商网络设备.

### 地址重叠

`Overlapping Address Spaces`, (VPN将两个数据中心连接起来, 应该看起来像一个数据中心一样)机构A和机构B都是用了`192.168.101.0/24`网段地址, 这就是地址重叠.

传统`BGP`无法正确处理地址空间重叠的`VPN`的路由.

如果机构A和机构B, 各自发布了一条去往此网段的路由, BGP只会选择其中一条路由, 从而导致去往另外一个`VPN`的路由丢失.

#### MP-BGP 解决地址重叠

`PE`路由器之间使用特殊的`MP-BGP`来发布`VPN`路由. 一般会在32位`IPv4`的地址之前加上一个客户标示的区分符用于客户地址的区分, 称为`VPN-IPv4`地址族, 这样`PE`路由器会受到如下的信息.

* 机构A的`192.168.101.0/24`往这走
* 机构B的`192.168.101.0/24`去往另外一个方向

#### 路由表解决地址重叠

解决`VPN`业务路由与普通路由不相互干扰.

`PE`上, 通过`VRF(VPN Routing&Forwarding Instance)`建立每个客户一个路由表, 与其他`VPN`客户路由和普通路由相互区分. 

**远端PE通过MP-BGP协议把业务路由放到近端PE, 近端PE根据不同的客户选择出相关客户的业务路由放到相应的`VRF`路由表中**

### VPN报文转发

两层标签方式:

* 外层: 标签在骨干网内部进行转发, 只是从PE到对端PE的一条LSP. **VPN 报文利用这层标签, 可以沿LSP到达对端PE**
* 内层: 标签从对端PE到达CE时使用, 在PE上, 通过查找VRF表项,指示报文应被送到哪个`VPN`用户(哪个CE). 对端`PE`根据内层标签可以找到转发报文的接口.

![](./img/22_13.jpg)

* 结构A 和机构 B 都发出一个目的地址为`192.168.101.10/24`的`IP`报文, 分别由各自的CE将报文送至PE
* PE会根据报文到达的接口及目的地址查找`VPN`实例表项`VRF`, 匹配后将报文转发出去 同时打上内层和外层两个标签. (假设通过MP-BGP配置的路由, 两个报文在骨干网走相同的路径)
* MPLS网络利用报文的外层标签, 将报文传送至出口PE, 报文在到达出口PE 2之前已经剥离外层标签, 仅含内层标签
* 出口PE根据内层标签和目的地址查找`VPN`示例表项`VRF`，确定报文的出接口, 将报文转发至各自的`CE`
* `CE`根据正常的`IP`转发过程将报文传送到目的地.

## 扩展

### IKE


